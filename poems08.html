<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è©©é‡ä»™è¹¤ - æ–°è©©å†’éšªéŠæˆ²</title>
    
    <!-- å¼•å…¥ Google Fonts (æ‰‹å¯«å­—é«”) -->
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">

    <!-- å¼•å…¥ Tailwind CSS (ç”¨æ–¼æ¨£å¼) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- å¼•å…¥ React å’Œ ReactDOM (ç”¨æ–¼æ ¸å¿ƒé‚è¼¯) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- å¼•å…¥ Babel (ç”¨æ–¼è§£æ JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* è‡ªå®šç¾©å‹•ç•«æ¨£å¼ */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(1.3); opacity: 0; }
        }
        .pulse-ring {
            animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
        @keyframes score-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.5); color: #fbbf24; }
            100% { transform: scale(1); }
        }
        .score-change {
            animation: score-pop 0.5s ease-out;
        }
        @keyframes heart-beat {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        @keyframes shake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }
        .chest-shake:hover {
            animation: shake 0.5s infinite;
        }
        @keyframes bounce-gentle {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .piece-idle {
            animation: bounce-gentle 2s infinite ease-in-out;
        }
    </style>
</head>
<body class="bg-green-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- æ•¸å­—è½‰ä¸­æ–‡å°ç…§è¡¨ ---
        const numToChinese = {
            1: 'ä¸€', 2: 'äºŒ', 3: 'ä¸‰', 4: 'å››', 5: 'äº”', 6: 'å…­', 7: 'ä¸ƒ'
        };

        // --- éš¨æ©Ÿæ´—ç‰Œå‡½æ•¸ ---
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // --- å…§å»ºåœ–ç¤ºçµ„ä»¶ ---
        const IconBase = ({ children, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const BookOpen = ({ className }) => <IconBase className={className}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconBase>;
        const Check = ({ className, size, strokeWidth }) => <svg xmlns="http://www.w3.org/2000/svg" width={size||24} height={size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth||2} strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"/></svg>;
        const Lock = ({ className, size }) => <svg xmlns="http://www.w3.org/2000/svg" width={size||24} height={size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>;
        const MapPin = ({ className, size, strokeWidth }) => <svg xmlns="http://www.w3.org/2000/svg" width={size||24} height={size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={strokeWidth||2} strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>;
        const Star = ({ className }) => <IconBase className={className}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></IconBase>;
        const Trophy = ({ className, size }) => <svg xmlns="http://www.w3.org/2000/svg" width={size||24} height={size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>;
        const ArrowRight = ({ className }) => <IconBase className={className}><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></IconBase>;
        const RefreshCw = ({ className }) => <IconBase className={className}><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></IconBase>;
        const Heart = ({ className, fill }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill={fill || "none"} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>;
        const Gift = ({ className, size }) => <svg xmlns="http://www.w3.org/2000/svg" width={size||24} height={size||24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/></svg>;
        const ChessPiece = ({ className, size }) => <svg xmlns="http://www.w3.org/2000/svg" width={size||24} height={size||24} viewBox="0 0 384 512" fill="currentColor" className={className}><path d="M192 0c53 0 96 43 96 96s-43 96-96 96-96-43-96-96S139 0 192 0zM64 224h256c35.3 0 64 28.7 64 64v32c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32v-32c0-35.3 28.7-64 64-64zM0 480c0-17.7 14.3-32 32-32h320c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32z"/></svg>;

        // --- éŠæˆ²è³‡æ–™è¨­å®š ---
        const GAME_DATA = [
          {
            id: 1, title: "ç¬¬ä¸€é—œï¼šå‹•ç‰©æ˜†èŸ²ç²¾éˆ", layout: { x: 56, y: 84 },
            questions: [
              { poem: "é é çš„ï¼Œéœæ‚„æ‚„çš„ï¼Œ\né–’ç½®åœ¨åœ°å¹³ç·šä¸Šæœ€é™°æš—çš„ä¸€è§’ï¼Œ\nä¸€æŠŠå¼µé–‹çš„é»‘é›¨å‚˜ã€‚", options: ["é´•é³¥", "è›‡", "èšŠ", "èœœèœ‚", "é›é³¥", "èŸ¬"], answer: "é´•é³¥" },
              { poem: "å†ç›´çš„è·¯ï¼Œä¹Ÿèµ°å¾—æ›²æŠ˜èœ¿èœ’ï¼Œè‰±é›£ç—›è‹¦ã€‚\nå¶çˆ¾ä¹Ÿæœƒåœä¸‹ä¾†ï¼Œ\næ˜‚é¦–å°è‘—ç„¡æ­¢ç„¡ç›¡çš„æ•‘è´–ä¹‹è·¯ï¼Œ\nå—¤å—¤åå¹¾ä¸‹èˆŒé ­ã€‚", options: ["é´•é³¥", "è›‡", "èšŠ", "èœœèœ‚", "é›é³¥", "èŸ¬"], answer: "è›‡" },
              { poem: "æ„Ÿè¬ä½ å€‘ï¼Œ\nå°æ–¼æˆ‘å°å°çš„å­˜åœ¨ï¼Œ\né‚„å ±äºˆç”Ÿå‘½æœ€ç†±çƒˆçš„æŒè²ã€‚", options: ["é´•é³¥", "è›‡", "èšŠ", "èœœèœ‚", "é›é³¥", "èŸ¬"], answer: "èšŠ" },
              { poem: "ä¸è«–å¹³åœ°èˆ‡å±±å°–ï¼Œ\nç„¡é™é¢¨å…‰ç›¡è¢«å ï¼Œ\nå¾—ç™¾èŠ±æˆèœœå¾Œï¼Œ\nç‚ºèª°è¾›è‹¦ç‚ºèª°ç”œã€‚", options: ["é´•é³¥", "è›‡", "èšŠ", "èœœèœ‚", "é›é³¥", "èŸ¬"], answer: "èœœèœ‚" },
              { poem: "æˆ‘å€‘ä»ç„¶æ´»è‘—ï¼Œä»ç„¶è¦é£›è¡Œã€‚\nåœ°å¹³ç·šé•·ä¹…åœ¨é è™•é€€ç¸®åœ°å¼•é€—è‘—æˆ‘å€‘æ´»è‘—ã€‚\nä¸æ–·åœ°è¿½é€ï¼Œæ„Ÿè¦ºå®ƒå·²æ¥è¿‘è€ŒæŠ¬çœ¼ï¼Œ\né‚„æ˜¯é‚£éº¼é™é ã€‚", options: ["é´•é³¥", "è›‡", "èšŠ", "èœœèœ‚", "é›é³¥", "èŸ¬"], answer: "é›é³¥" },
              { poem: "ç›´åˆ°ç–²å€¦ä¹Ÿå–Šå‡ºäº†ç”Ÿå‘½çš„æ²™å•ï¼Œ\nåœ¨ç¾½ç¿¼ç”ŸéŠ¹çš„å¤¢è£ã€‚\nå¤å¤©æœ€é æˆ‘æ›¾æŠµé”ï¼Œ\nä¸€å€‹å……æ»¿è¬ è¨€è€Œåˆé™Œç”Ÿçš„åŸå¸‚ã€‚", options: ["é´•é³¥", "è›‡", "èšŠ", "èœœèœ‚", "é›é³¥", "èŸ¬"], answer: "èŸ¬" }
            ]
          },
          {
            id: 2, title: "ç¬¬äºŒé—œï¼šæ¤ç‰©ç²¾éˆ", layout: { x: 99, y: 90 },
            questions: [
              { poem: "ä¸€è¡Œç´°ç˜¦çš„å­—é«”ï¼Œ\nå‡¸å¯«å‡ºé£„é€¸æ¸…é«˜çš„æ€§æƒ…ã€‚", options: ["ç«¹", "è–èª•ç´…", "æ¥“è‘‰", "èŠèŠ±", "å«ç¾è‰", "æŸ³"], answer: "ç«¹" },
              { poem: "å¹´å¹´ç§‹åŠ«ä¹‹å¾Œè¬èŠ±è½ç›¡ï¼Œ\nä½ æ“ä¸€å¢å¢ç´…è±”ï¼Œå¦‚æ“ä¸€æ”¯ä¸€æ”¯ç«ç‚¬ï¼Œ\nè‡ªå†°å†·å†·çš„å°å‡ï¼Œé»˜é»˜ç‡ƒç‚¬ã€‚", options: ["ç«¹", "è–èª•ç´…", "æ¥“è‘‰", "èŠèŠ±", "å«ç¾è‰", "æŸ³"], answer: "è–èª•ç´…" },
              { poem: "ç§‹å¤©ï¼Œæœ€å®¹æ˜“å—å‚·çš„è¨˜æ†¶ï¼Œ\néœœé½’ä¸€å’¬ï¼Œå™¢!é‚£æ¨£è¼•è¼•ï¼Œ\nå°±å’¬å‡ºä¸€æŒè¡€ä¾†ã€‚", options: ["ç«¹", "è–èª•ç´…", "æ¥“è‘‰", "èŠèŠ±", "å«ç¾è‰", "æŸ³"], answer: "æ¥“è‘‰" },
              { poem: "è¥¿é¢¨å¹ä¾†ï¼Œå¥¹ç²ç“çš„èº«å­é™ä¸‹éœœåšçš„è¡£è¡«ã€‚\nç„¶å¾Œï¼Œå¥¹ç”¨ä¸€éš»è©©æ­Œçš„æ‰‹ä½æ±ç±¬ã€‚\næ‚ ç„¶ï¼Œä¸€ç‰‡å—å±±ã€‚", options: ["ç«¹", "è–èª•ç´…", "æ¥“è‘‰", "èŠèŠ±", "å«ç¾è‰", "æŸ³"], answer: "èŠèŠ±" },
              { poem: "æ˜¯çš„ï¼Œæˆ‘å€‘å¾ˆå½†æ‰­çš„ï¼Œ\nä¸æ•¢è¿å‘ä»»ä½•ä¸€ç¨®æ’«è§¸ã€‚\nä¸€è½åˆ°èª°çš„è²éŸ³è¿«è¿‘ï¼Œä¾¿ç·Šå¼µæ‘ºç·Šè‡ªå·±ï¼Œ\nä»¥å¯†å¯†çš„ã€å°å°çš„åˆºï¼Œè¡›è­·è‡ªå·±ã€‚", options: ["ç«¹", "è–èª•ç´…", "æ¥“è‘‰", "èŠèŠ±", "å«ç¾è‰", "æŸ³"], answer: "å«ç¾è‰" },
              { poem: "æé¬¥çº–è…°è‘‰é¬¥çœ‰ï¼Œ\næ˜¥ä¾†ä½•è™•ä¸çŸ¥çµ²ï¼Œ\nçé™µåŸä¸Šå¤šé›¢åˆ¥ï¼Œ\nå°‘æœ‰é•·æ¢æ‹‚åœ°å‚ã€‚", options: ["ç«¹", "è–èª•ç´…", "æ¥“è‘‰", "èŠèŠ±", "å«ç¾è‰", "æŸ³"], answer: "æŸ³" }
            ]
          },
          {
            id: 3, title: "ç¬¬ä¸‰é—œï¼šæ°´æœç²¾éˆ", layout: { x: 87, y: 53 },
            questions: [
              { poem: "æ»¿å¤©çš„æ˜Ÿå­ï¼Œ\nä¸ç”˜ç•¶æœˆå…’çš„é…è§’ï¼Œæ–¼æ˜¯å¢œå…¥å‡¡å¡µã€‚\nå»æ²’æ–™åˆ°åœ¨è¬ç´«åƒç´…ä¸­ï¼Œ\nä»é€ƒä¸æ‰å®¿å‘½çš„å®‰æ’ï¼Œè®Šæˆäº†â—‹â—‹ã€‚", options: ["æ¥Šæ¡ƒ", "æ¡ƒ", "å“ˆå¯†ç“œ", "é³³æ¢¨", "è”æ", "è¥¿ç“œ"], answer: "æ¥Šæ¡ƒ" },
              { poem: "åœ¨ä½ æœ‰è‘—å­©å­çš„ï¼Œ\næˆ–è€…å°‘å¥³çš„é¢é °ä¸€æ¨£è‰²å½©çš„æ™‚å€™ï¼Œ\näººå€‘å‰å¥ªäº†ä½ çš„è‚‰çš®ã€‚\næ–¼æ˜¯è²ªå©ªè€…æ»¿è¶³äº†ï¼Œé„™è¦–åœ°æŠ•è½ä½ çš„æ ¸ã€‚\nä½ å¾æ³¥æ¿˜ä¸­èˆ‡å …ç¡¬çš„æ²™åœŸä¸­æ™æ‰è‘—ï¼Œ\nçµ‚æ–¼ä½ ç«™ç©©äº†è…³è·Ÿï¼Œå‘å¤©ç©ºèˆ‰èµ·æ­¡å‘¼çš„æ‰‹ã€‚", options: ["æ¥Šæ¡ƒ", "æ¡ƒ", "å“ˆå¯†ç“œ", "é³³æ¢¨", "è”æ", "è¥¿ç“œ"], answer: "æ¡ƒ" },
              { poem: "å¯†å¯†çš„ç¶²å¯å¦ç¶²ä½ä½ çš„å¿ƒï¼Ÿ\nç”œç”œçš„æ»‹å‘³å¯å¦ç•™ä½ä½ çš„æƒ…ï¼Ÿ\nå¯æ„›çš„ä½ å¯æ‡‚å¾—æˆ‘ç¶¿å¯†çš„å¿ƒã€ç´°ç·»çš„æƒ…ï¼Ÿ", options: ["æ¥Šæ¡ƒ", "æ¡ƒ", "å“ˆå¯†ç“œ", "é³³æ¢¨", "è”æ", "è¥¿ç“œ"], answer: "å“ˆå¯†ç“œ" },
              { poem: "åƒå°åœ°å®‰çš„æ­¦å£«ï¼Œ\né›„å£¯å¨æ­¦çš„ç›´ç«‹è‘—ï¼›\nä»–é‚£å …å›ºçš„ç›”ç”²è£¡ï¼Œ\nå»æ·±è—è‘—ä¸€é¡†ç”œèœœåˆå …æ¯…çš„å¿ƒã€‚", options: ["æ¥Šæ¡ƒ", "æ¡ƒ", "å“ˆå¯†ç“œ", "é³³æ¢¨", "è”æ", "è¥¿ç“œ"], answer: "é³³æ¢¨" },
              { poem: "ä¸å¿…å¦ƒå­åœ¨é©ªå±±ä¸Šè‹¦ç­‰\nä¸€åŒ¹æ±—é¦¬è¸¢è¸è‘—ç´…å¡µ\nå¥ªä¾†å—æ–¹å¸¶éœ²çš„æ–°é®®\nä¹Ÿä¸å¿…è©©äººè²¶å®˜åˆ°å¶ºå¤–\næŠŠè¬é‡Œçš„åŠ«é›£æ›ä¸€ç›¤å£ç¦ã€‚", options: ["æ¥Šæ¡ƒ", "æ¡ƒ", "å“ˆå¯†ç“œ", "é³³æ¢¨", "è”æ", "è¥¿ç“œ"], answer: "è”æ" },
              { poem: "å’šå’šå’šï¼Œæ˜¯å¤å¤©è£¡ç‰¹æœ‰çš„é¼“è²ï¼Œ\nå–šé†’äº†äººå€‘é†é†çŒé ‚çš„æ¸´æœ›ã€‚\næ¯‹é ˆæ­£æ¸¯çš„é»‘æ¾æ²™å£«ï¼Œ\næ›´ä¸ç”¨ç¾ç¾çš„æä»”å†°ï¼Œä¸€æ¨£èƒ½æ¸…æ¶¼ç—›å¿«ã€‚", options: ["æ¥Šæ¡ƒ", "æ¡ƒ", "å“ˆå¯†ç“œ", "é³³æ¢¨", "è”æ", "è¥¿ç“œ"], answer: "è¥¿ç“œ" }
            ]
          },
          {
            id: 4, title: "ç¬¬å››é—œï¼šè‡ªç„¶ç¾è±¡ç²¾éˆ", layout: { x: 56, y: 44 },
            questions: [
              { poem: "éœæ­¢çš„äº‹ç‰©ï¼Œ\nç¾¤æƒ…é¨·å‹•ã€‚", options: ["é¢¨", "é›²", "éœ§", "æµæ˜Ÿ", "å¤§é›¨", "æµ·æµª"], answer: "é¢¨" },
              { poem: "å¯å¡‘æ€§æ¥µé«˜ä¹‹é»åœŸï¼Œ\néš¨é¢¨æé€ ã€‚", options: ["é¢¨", "é›²", "éœ§", "æµæ˜Ÿ", "å¤§é›¨", "æµ·æµª"], answer: "é›²" },
              { poem: "å é ˜é¢¨æ™¯å¿…å‚™ä¹‹ï¼Œ\nç™½çš®æ›¸ã€‚", options: ["é¢¨", "é›²", "éœ§", "æµæ˜Ÿ", "å¤§é›¨", "æµ·æµª"], answer: "éœ§" },
              { poem: "æè‘—ç‰ç’ƒå®®ç‡ˆçš„å¬ªå¦ƒå€‘ï¼Œ\nå¹½å¹½åœ°æ¸¡éå¤©æ²³ã€‚\nä¸€å€‹åå«æ…§çš„å§‘å¨˜ï¼Œ\nå‘€çš„ä¸€è²æ»‘å€’äº†ã€‚", options: ["é¢¨", "é›²", "éœ§", "æµæ˜Ÿ", "å¤§é›¨", "æµ·æµª"], answer: "æµæ˜Ÿ" },
              { poem: "å¤æ—¥çš„é•·é«®ï¼Œå¾å¤©ä¸Šç›´å€’ä¸‹ä¾†ï¼Œ\néœ¹é‚æ‹å•¦çš„å¥”é¼“ï¼Œæ»¾æ»¾è€Œè‡³ï¼Œ\nå¯èªªæ˜¯è«¸å¤©éœ‡å‹•ï¼Œå¤§åœ°é©šé›·ã€‚", options: ["é¢¨", "é›²", "éœ§", "æµæ˜Ÿ", "å¤§é›¨", "æµ·æµª"], answer: "å¤§é›¨" },
              { poem: "ä¸€è¬åŒ¹é£„è‘—ç™½é¬£çš„è—é¦¬ï¼Œ\nå‘¼å˜¯è‘—ï¼Œç–¾å¥”éæˆ‘çš„è…³ä¸‹ã€‚\né€™åŒ¹éŠœè‘—é‚£åŒ¹çš„å°¾å·´ï¼Œ\nç›´å¥”å‘å†¥å†¥ã€å¯å¯çš„å¤©æ¶¯ã€‚", options: ["é¢¨", "é›²", "éœ§", "æµæ˜Ÿ", "å¤§é›¨", "æµ·æµª"], answer: "æµ·æµª" }
            ]
          },
          {
            id: 5, title: "ç¬¬äº”é—œï¼šç”Ÿæ´»ç‰©å“ç²¾éˆ", layout: { x: 10, y: 38 },
            questions: [
              { poem: "æ¨å§ï¼ç¹ä¸€å€‹éœå¯‚çš„ä¸­å¿ƒï¼Œ\næ¨å‹•æ‰€æœ‰é‡‘ç£¨å­æˆä¸€åº§ç£¨åŠã€‚\næµéä¸–ç´€ï¼Œç£¨æˆäº†æ­²æœˆï¼›\næµéæ­²æœˆï¼Œç£¨æˆäº†æ™‚è¾°ï¼›\næµéæ™‚è¾°ï¼Œç£¨æˆäº†åˆ†ç§’ã€‚\næ¶“æ¶“æ»´æ»´ï¼Œå¾è™Ÿç¨±ä¸é€æ°´çš„é–˜é–€ï¼Œå·å·åœ°æ¼å»ã€‚", options: ["é˜éŒ¶", "é¦¬æ¡¶", "é›»é¢¨æ‰‡", "ç­·å­", "è¼ªèƒ", "è Ÿç‡­"], answer: "é˜éŒ¶" },
              { poem: "ç•¶æˆ‘å€†å£å°å£ï¼Œ\nå¦³ç¸½æ„›å‚¾ç€‰æ»¿è‚šå­çš„è‹¦æ°´ã€‚\næ™‚è€Œæ°£å‹¢æ»‚æ²±ï¼Œæ™‚è€Œæ–·æ–·çºŒçºŒï¼Œ\nç­‰ä½ å¸¶èµ°äº†æ˜¨å¤œçš„æº«å­˜ï¼Œ\nç•™çµ¦æˆ‘çš„å»æ˜¯ä¹…ä¹…æœªæ¶ˆçš„å»ç—•ï¼Œ\nå’Œæ®ä¹‹ä¸å»çš„é¤˜å‘³ã€‚", options: ["é˜éŒ¶", "é¦¬æ¡¶", "é›»é¢¨æ‰‡", "ç­·å­", "è¼ªèƒ", "è Ÿç‡­"], answer: "é¦¬æ¡¶" },
              { poem: "æ²’æœ‰é¢¨çš„æ—¥å­æ˜¯ä¼‘æ­¢ç¬¦è­œå‡ºçš„å­£ç¯€ï¼Œ\nå¾˜å¾Šçš„å¤¢æƒ³èµ°ä¸å‡ºå†¬å¤©ã€‚\næ‹”æ‰è¨˜æ†¶çš„æ’é ­ï¼Œæˆ‘åŸ·è‘—æ–¼æ—‹è½‰çš„é¢¨ï¼Œ\nå¼·ä¸­å¼±ï¼Œåœã€‚", options: ["é˜éŒ¶", "é¦¬æ¡¶", "é›»é¢¨æ‰‡", "ç­·å­", "è¼ªèƒ", "è Ÿç‡­"], answer: "é›»é¢¨æ‰‡" },
              { poem: "ä¸€å°æ©æ„›çš„å¤«å¦»ï¼Œ\nåŒåšé…¸ç”œè‹¦è¾£ã€‚", options: ["é˜éŒ¶", "é¦¬æ¡¶", "é›»é¢¨æ‰‡", "ç­·å­", "è¼ªèƒ", "è Ÿç‡­"], answer: "ç­·å­" },
              { poem: "ä¸€ç¨®ç”¨ä¾†æ“¦æ‹­è·é›¢çš„æ©¡çš®ï¼Œ\nå»æ“¦ä¸å»ä¸€è·¯çš„å´å¶‡ã€‚", options: ["é˜éŒ¶", "é¦¬æ¡¶", "é›»é¢¨æ‰‡", "ç­·å­", "è¼ªèƒ", "è Ÿç‡­"], answer: "è¼ªèƒ" },
              { poem: "åŒ äººé€ äº†ä½ ï¼ŒåŸæ˜¯ç‚ºç‡’çš„ï¼Œ\næ—¢å·²ç‡’è‘—ï¼Œåˆä½•è‹¦å‚·å¿ƒæµæ·šã€‚", options: ["é˜éŒ¶", "é¦¬æ¡¶", "é›»é¢¨æ‰‡", "ç­·å­", "è¼ªèƒ", "è Ÿç‡­"], answer: "è Ÿç‡­" }
            ]
          },
          {
            id: 6, title: "ç¬¬å…­é—œï¼šæ„Ÿå®˜ç²¾éˆ", layout: { x: 10, y: -5 },
            questions: [
              { poem: "æ­²æœˆçš„é½’è¼ªè¼¾å‡ºçš„æˆ°å£•ï¼Œ\næœ‰æ™‚è‡³æ­»ä¹Ÿé‡ä¸è¦‹æˆ°çˆ­ã€‚", options: ["çšºç´‹", "çœ‰", "è€³", "çœ¼", "å£", "é¼»"], answer: "çšºç´‹" },
              { poem: "åªæœ‰ç¿…ç¿¼ï¼Œè€Œç„¡èº«è»€çš„é³¥ï¼Œ\nåœ¨å“­å’Œç¬‘ä¹‹é–“ä¸æ–·é£›ç¿”ã€‚", options: ["çšºç´‹", "çœ‰", "è€³", "çœ¼", "å£", "é¼»"], answer: "çœ‰" },
              { poem: "è¬ç„¡ä¸€å¤±ï¼›å¯†èªè¦è¼•è¼•å‚³é€ã€‚\nå‘ç© é‚ƒçš„é«®å¢ï¼Œå‘ä¸€éš»æš–è±¡ç‰™çš„é›•åˆ»ï¼Œ\nå·¦é¬¢ç²¾å·§ï¼Œå³é¬¢æ›´ç²ç“ï¼Œ\nå¹½å¾‘ï¼Œæœ‰ä¸€æ›²æš—é€šã€‚", options: ["çšºç´‹", "çœ‰", "è€³", "çœ¼", "å£", "é¼»"], answer: "è€³" },
              { poem: "ä¸€å°ç›¸æˆ€çš„é­šï¼Œå°¾å·´è¦åœ¨å››åæ­²ä»¥å¾Œæ‰å‡ºç¾ã€‚\nä¸­é–“éš”è‘—ä¸€é“é¼»æ¨‘ï¼Œæœ‰å¦‚æˆ‘å’Œæˆ‘çš„å®¶äººï¼Œ\nä¸­é–“éš”è‘—ä¸€æ¢æµ·å³½ã€‚\né€™è¼©å­æ€•æ˜¯ç„¡æ³•ç›¸è¦‹çš„äº†ï¼Œå¶çˆ¾ä¹Ÿæœƒæ··åœ¨ä¸€èµ·ï¼Œ\nåªæ˜¯åœ¨å¤¢ä¸­ä»–å€‘çš„æ·šã€‚", options: ["çšºç´‹", "çœ‰", "è€³", "çœ¼", "å£", "é¼»"], answer: "çœ¼" },
              { poem: "å”¯åƒæ˜¯ç¬¬ä¸€ç¾©çš„ï¼Œ\næ­Œå¶çˆ¾ä¹Ÿå”±ï¼Œä¹Ÿæ›¾å»éä¸å°‘çš„ï¼Œ\nå•Šâ€”é…’ç“¶ã€‚", options: ["çšºç´‹", "çœ‰", "è€³", "çœ¼", "å£", "é¼»"], answer: "å£" },
              { poem: "æ²’æœ‰ç¢‘ç¢£ï¼Œé›™ç©´çš„å¢“ã€‚\næ¢å±±ä¼¯å’Œç¥è‹±å°ï¼Œå°±è‘¬åœ¨é€™è£¡ã€‚", options: ["çšºç´‹", "çœ‰", "è€³", "çœ¼", "å£", "é¼»"], answer: "é¼»" }
            ]
          },
          {
            id: 7, title: "ç¬¬ä¸ƒé—œï¼šäººç”Ÿæ—…ç¨‹ç²¾éˆ", layout: { x: 38, y: 4 },
            questions: [
              { poem: "â–¡â–¡æ˜¯ä¸€åŒ¹éŒ¦ç¶ºï¼Œ\næ™‚é–“æ˜¯ä¸€æŠŠå‰ªåˆ€ï¼Œä¸€ç¯€ä¸€ç¯€åœ°å‰ªå»ï¼Œ\nç­‰åˆ°å‰ªå®Œçš„æ™‚å€™ï¼ŒæŠŠä¸€å †ç ´å¸ƒä»˜ä¹‹ä¸€ç‚¬ã€‚", options: ["ç”Ÿå‘½", "éŒ¯èª¤", "è¥è¤“"], answer: "ç”Ÿå‘½" },
              { poem: "ä»–å°±ä½åœ¨çœŸç†çš„éš”å£ï¼Œ\nå› æ­¤å¸¸ä½¿æˆ‘å€‘ä¸Šç•¶ã€‚", options: ["ç”Ÿå‘½", "éŒ¯èª¤", "è¥è¤“"], answer: "éŒ¯èª¤" },
              { poem: "å…¥ä¸–ä¹Ÿç­‰æ–¼å‡ºä¸–ï¼Œ\nå¯†å¯†è€Œç¸«çš„ç™¾è¡²ï¼Œæœ€é›£ç¸«åˆçš„æ¯è¦ªçš„é™£ç—›ã€‚\nçŒ¶æ˜¯è²¼èº«æº«æŸ”ï¼Œè£¹è‘—æš—æš—ä¹³é¦™çš„æ˜¥å¤©ã€‚", options: ["ç”Ÿå‘½", "éŒ¯èª¤", "è¥è¤“"], answer: "è¥è¤“" }
            ]
          }
        ];

        // èµ·é»èˆ‡çµ‚é»åº§æ¨™
        const START_POS = { x: 10, y: 90 };
        const END_POS = { x: 90, y: 10 };
        // å¯¶ç®±ä½ç½® (ç¬¬å››é—œèˆ‡ç¬¬äº”é—œä¸­é–“)
        const CHEST_POS = { x: 33, y: 41 };

        function PoetryGame() {
          const [gameState, setGameState] = useState('start'); // start, map, quiz, win, fail
          const [currentLevelId, setCurrentLevelId] = useState(1);
          const [currentQuestionIdx, setCurrentQuestionIdx] = useState(0);
          const [unlockedLevel, setUnlockedLevel] = useState(1);
          const [selectedAnswer, setSelectedAnswer] = useState(null);
          const [isCorrect, setIsCorrect] = useState(null);
          const [score, setScore] = useState(0);
          const [lives, setLives] = useState(5); // ç”Ÿå‘½å€¼
          const [chestOpened, setChestOpened] = useState(false); // å¯¶ç®±æ˜¯å¦å·²é–‹å•Ÿ
          const [showChestModal, setShowChestModal] = useState(false); // é¡¯ç¤ºå¯¶ç®±æŠ½çè¦–çª—
          const [chestMessage, setChestMessage] = useState(null); // æŠ½ççµæœè¨Šæ¯
          
          // æ£‹å­ä½ç½®ç‹€æ…‹
          const [piecePos, setPiecePos] = useState(START_POS);

          // éŸ³æ¨‚åƒè€ƒ
          const audioRef = useRef(null);

          // åˆå§‹åŒ–éŸ³æ•ˆç‰©ä»¶ (èƒŒæ™¯éŸ³æ¨‚)
          useEffect(() => {
            const audio = new Audio('å¥‡å¹»æ£®æ—.mp3');
            audio.loop = true;
            audioRef.current = audio;
            return () => {
                audio.pause();
            };
          }, []);

          // é–‹å§‹å†’éšª (æ’­æ”¾éŸ³æ¨‚)
          const startAdventure = () => {
            setGameState('map');
            if (audioRef.current) {
                audioRef.current.play().catch(e => console.log("éœ€ä½¿ç”¨è€…äº’å‹•æ‰èƒ½æ’­æ”¾éŸ³æ¨‚"));
            }
          };

          // éŸ³æ•ˆè™•ç†å‡½æ•¸ (æ•´åˆæ‰€æœ‰éŸ³æ•ˆ)
          const playSound = (type) => {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;
            const ctx = new AudioContext();
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);

            if (type === 'correct') { // ç­”å°: é«˜éŸ³å®
              oscillator.type = 'sine';
              oscillator.frequency.setValueAtTime(600, ctx.currentTime);
              oscillator.frequency.exponentialRampToValueAtTime(800, ctx.currentTime + 0.1);
              gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
              oscillator.start();
              oscillator.stop(ctx.currentTime + 0.5);
            } else if (type === 'wrong') { // ç­”éŒ¯: ä½éŸ³é‹¸é½’
              oscillator.type = 'sawtooth';
              oscillator.frequency.setValueAtTime(150, ctx.currentTime);
              oscillator.frequency.linearRampToValueAtTime(100, ctx.currentTime + 0.3);
              gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
              oscillator.start();
              oscillator.stop(ctx.currentTime + 0.3);
            } else if (type === 'cheer') { // å¯¶ç®±æ­å–œ: ç¶éŸ³
                oscillator.type = 'triangle';
                oscillator.frequency.setValueAtTime(400, ctx.currentTime);
                oscillator.frequency.setValueAtTime(500, ctx.currentTime + 0.1);
                oscillator.frequency.setValueAtTime(600, ctx.currentTime + 0.2);
                oscillator.frequency.setValueAtTime(800, ctx.currentTime + 0.3);
                gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.6);
                oscillator.start();
                oscillator.stop(ctx.currentTime + 0.6);
            } else if (type === 'sigh') { // å¯¶ç®±å¯æƒœ: ä¸‹æ»‘éŸ³
                oscillator.type = 'triangle';
                oscillator.frequency.setValueAtTime(300, ctx.currentTime);
                oscillator.frequency.linearRampToValueAtTime(200, ctx.currentTime + 0.4);
                gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);
                oscillator.start();
                oscillator.stop(ctx.currentTime + 0.4);
            }
          };

          // ç”¢ç”Ÿå¹³æ»‘æ›²ç·šè·¯å¾‘æ•¸æ“š
          const getSmoothPath = () => {
            const points = [START_POS, ...GAME_DATA.map(l => l.layout), END_POS];
            if (points.length < 2) return "";

            let d = `M ${points[0].x} ${points[0].y}`;

            for (let i = 0; i < points.length - 1; i++) {
                const p0 = points[i == 0 ? 0 : i - 1];
                const p1 = points[i];
                const p2 = points[i + 1];
                const p3 = points[i + 2] || p2;

                const cp1x = p1.x + (p2.x - p0.x) * 0.2;
                const cp1y = p1.y + (p2.y - p0.y) * 0.2;

                const cp2x = p2.x - (p3.x - p1.x) * 0.2;
                const cp2y = p2.y - (p3.y - p1.y) * 0.2;

                d += ` C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${p2.x} ${p2.y}`;
            }
            return d;
          };

          // è™•ç†é—œå¡é»æ“Šï¼šç§»å‹•æ£‹å­ -> å»¶é² -> é€²å…¥é—œå¡
          const handleLevelClick = (levelId) => {
            // å¦‚æœè©²é—œå¡å°šæœªè§£é–ï¼Œå‰‡ä¸å‹•ä½œ
            if (levelId > unlockedLevel) return;
            
            // 1. ç§»å‹•æ£‹å­åˆ°è©²é—œå¡ä½ç½®
            const targetLevel = GAME_DATA.find(l => l.id === levelId);
            setPiecePos(targetLevel.layout);
            setCurrentLevelId(levelId);
            
            // 2. å»¶é² 1 ç§’è®“å‹•ç•«æ’­æ”¾å®Œç•¢ï¼Œå†é€²å…¥ç­”é¡Œ
            setTimeout(() => {
                setCurrentQuestionIdx(0);
                setGameState('quiz');
                setSelectedAnswer(null);
                setIsCorrect(null);
            }, 1000);
          };

          // è™•ç†çµ‚é»é»æ“Š
          const handleEndClick = () => {
              // åªæœ‰ç•¶ç¬¬ä¸ƒé—œå·²é€šé (unlockedLevel > 7) æ‰èƒ½é»æ“Šçµ‚é»
              if (unlockedLevel <= 7) return;

              setPiecePos(END_POS);
              setTimeout(() => {
                  setGameState('win');
              }, 1000);
          };

          const handleChestClick = () => {
              if (unlockedLevel >= 5 && !chestOpened) {
                  setShowChestModal(true);
                  setChestMessage(null);
              }
          };

          const openChest = (chestId) => {
              // çå‹µæ± : å…¨æ»¿ (5), +1, +0
              const outcomes = ['full', 'plus1', 'zero'];
              const result = outcomes[Math.floor(Math.random() * outcomes.length)];
              
              let msg = "";
              if (result === 'full') {
                  setLives(5);
                  msg = "é‹æ°£çˆ†æ£šï¼è¡€é‡å…¨æ»¿ï¼";
                  playSound('cheer');
              } else if (result === 'plus1') {
                  setLives(prev => Math.min(prev + 1, 5));
                  msg = "æ­å–œï¼è¡€é‡ +1";
                  playSound('cheer');
              } else {
                  msg = "å“å‘€... å¯¶ç®±æ˜¯ç©ºçš„ (+0)";
                  playSound('sigh');
              }

              setChestMessage(msg);
              setChestOpened(true);
              
              // 2ç§’å¾Œé—œé–‰è¦–çª—
              setTimeout(() => {
                  setShowChestModal(false);
                  setChestMessage(null);
              }, 2500);
          };

          const handleAnswerCheck = (option) => {
            const currentLevelData = GAME_DATA.find(l => l.id === currentLevelId);
            const currentQuestion = currentLevelData.questions[currentQuestionIdx];
            
            setSelectedAnswer(option);
            
            if (option === currentQuestion.answer) {
              setIsCorrect(true);
              playSound('correct');
              setScore(prev => prev + 1000);
              setTimeout(() => {
                if (currentQuestionIdx < currentLevelData.questions.length - 1) {
                  setCurrentQuestionIdx(prev => prev + 1);
                  setSelectedAnswer(null);
                  setIsCorrect(null);
                } else {
                  // æœ¬é—œå¡æ‰€æœ‰é¡Œç›®ç­”å°
                  if (currentLevelId === GAME_DATA.length) {
                    // ç¬¬ä¸ƒé—œé€šé -> è§£é–çµ‚é» (è¨­å®š unlockedLevel ç‚º 8)
                    setUnlockedLevel(8);
                    setGameState('map');
                  } else {
                    // å…¶ä»–é—œå¡é€šé -> è§£é–ä¸‹ä¸€é—œ
                    if (currentLevelId === unlockedLevel) {
                      setUnlockedLevel(prev => prev + 1);
                    }
                    setGameState('map');
                  }
                }
              }, 1200);
            } else {
              setIsCorrect(false);
              playSound('wrong');
              setLives(prevLives => {
                  const newLives = prevLives - 1;
                  if (newLives <= 0) {
                      setTimeout(() => setGameState('fail'), 800);
                  }
                  return newLives;
              });
            }
          };

          const resetGame = () => {
            setGameState('start');
            setCurrentLevelId(1);
            setCurrentQuestionIdx(0);
            setUnlockedLevel(1);
            setSelectedAnswer(null);
            setIsCorrect(null);
            setScore(0);
            setLives(5);
            setChestOpened(false);
            setShowChestModal(false);
            setPiecePos(START_POS); // æ£‹å­æ­¸ä½
          };

          const currentLevelData = GAME_DATA.find(l => l.id === currentLevelId);
          const currentQuestionData = currentLevelData ? currentLevelData.questions[currentQuestionIdx] : null;
          
          const fixedLevelOptions = useMemo(() => {
            if (!currentLevelData) return [];
            return shuffleArray(currentLevelData.questions[0].options);
          }, [currentLevelId]);

          // --- æ¸²æŸ“ç•«é¢ ---

          // 1. èµ·å§‹ç•«é¢
          if (gameState === 'start') {
            return (
              <div 
                className="min-h-screen flex flex-col items-center justify-center p-4 text-white relative overflow-hidden font-sans"
                style={{
                    backgroundImage: 'url("./è©©é‡ä»™è¹¤.png")',
                    backgroundSize: 'cover',
                    backgroundPosition: 'center',
                    backgroundRepeat: 'no-repeat',
                    backgroundColor: '#312e81'
                }}
              >
                <div className="absolute inset-0 bg-black/60 pointer-events-none"></div>
                <div className="bg-white/10 backdrop-blur-md p-8 rounded-2xl shadow-2xl border border-white/20 text-center max-w-lg w-full z-10">
                  <h1 className="text-7xl text-yellow-300 mb-4" style={{ fontFamily: "'Dancing Script', cursive" }}>Poems</h1>
                  <h2 className="text-5xl font-bold mb-2 tracking-wider text-yellow-300 drop-shadow-lg">è©©é‡ä»™è¹¤</h2>
                  <p className="text-xl text-gray-200 mb-8 font-light">ä¸€å ´çµåˆæ–°è©©èˆ‡å†’éšªçš„å¥‡å¹»æ—…ç¨‹</p>
                  <div className="space-y-4 text-left bg-black/40 p-6 rounded-xl mb-8 border border-white/10">
                    <p className="flex items-start">
                        <MapPin className="mr-3 mt-1 text-pink-400 shrink-0" /> 
                        <span>å°å¼Ÿå¼Ÿæ¬£è³å®Œå¤å¤œé€™é¦–è©©å¾Œã€‚é€™å¤©æ™šä¸Šå¤¢è¦‹äº†ä»–é€²å…¥äº†è¿·éœ§æ£®æ—ä¹‹ä¸­å†’éšªï¼Œè¨±å¤šèº«é‚Šçš„äº‹ç‰©éƒ½åŒ–ä½œè©©å¥ç²¾éˆï¼Œè€ƒé©—è‘—ä»–â€¦â€¦</span>
                    </p>
                    <p className="flex items-start">
                        <BookOpen className="mr-3 mt-1 text-blue-400 shrink-0" /> 
                        <span>é–±è®€æ–°è©©è¬é¡Œï¼ŒçŒœå‡ºæ­£ç¢ºç­”æ¡ˆï¼Œå”åŠ©å°å¼Ÿå¼Ÿåœ¨å¤¢å¢ƒä¸­æ‰¾åˆ°å›å®¶çš„è·¯ï¼Œåšå€‹é¦™ç”œçš„å¤¢ã€‚</span>
                    </p>
                    <p className="flex items-center">
                        <Star className="mr-3 text-yellow-400 shrink-0" /> 
                        <span>ç­”å°ä¸€é¡Œå¾— 1000 åˆ†ï¼ŒæŒ‘æˆ°æœ€é«˜åˆ†ï¼</span>
                    </p>
                  </div>
                  <button onClick={startAdventure} className="w-full bg-yellow-400 hover:bg-yellow-300 text-purple-900 font-bold py-4 px-8 rounded-full text-xl transition-all transform hover:scale-105 shadow-lg flex items-center justify-center">
                    é–‹å§‹å†’éšª <ArrowRight className="ml-2" />
                  </button>
                </div>
              </div>
            );
          }

          // 2. å‹åˆ©ç•«é¢
          if (gameState === 'win') {
            return (
              <div 
                className="min-h-screen flex flex-col items-center justify-center p-4 text-white text-center relative overflow-hidden font-sans"
                style={{
                    backgroundImage: 'url("./çµå°¾.png")',
                    backgroundSize: 'cover',
                    backgroundPosition: 'center',
                    backgroundRepeat: 'no-repeat',
                    backgroundColor: '#ca8a04'
                }}
              >
                <div className="absolute inset-0 bg-black/50 pointer-events-none"></div>
                <div className="relative z-10">
                    <div className="animate-bounce mb-8">
                      <Trophy className="w-32 h-32 text-yellow-300 drop-shadow-2xl mx-auto" />
                    </div>
                    <h1 className="text-6xl font-bold mb-4 text-yellow-100">æ­å–œé€šé—œï¼</h1>
                    <p className="text-3xl mb-4 font-bold text-yellow-200">æœ€çµ‚å¾—åˆ†ï¼š{score}</p>
                    <p className="text-2xl mb-4 font-bold text-yellow-100 drop-shadow-md">å°å¼Ÿå¼Ÿçµ‚æ–¼åœ¨å¤¢å¢ƒä¸­æ‰¾åˆ°äº†å›å®¶çš„è·¯ï¼Œåšå€‹é¦™ç”œçš„å¤¢ã€‚</p>
                    <p className="text-2xl mb-8 max-w-md mx-auto">ä½ å·²ç¶“é€šéäº†æ‰€æœ‰çš„æ–°è©©è€ƒé©—ï¼Œæˆç‚ºäº†çœŸæ­£çš„ã€Œè©©é‡ä»™è¹¤ã€å¤§å¸«ï¼</p>
                    <button onClick={resetGame} className="bg-white text-red-600 hover:bg-gray-100 font-bold py-3 px-8 rounded-full text-lg transition-colors flex items-center shadow-xl mx-auto">
                      <RefreshCw className="mr-2" /> é‡æ–°é–‹å§‹
                    </button>
                </div>
              </div>
            );
          }

          // 2.5 å¤±æ•—ç•«é¢
          if (gameState === 'fail') {
            const failImage = `./ç¬¬${numToChinese[currentLevelId]}é—œå¤±æ•—.png`;
            return (
              <div 
                className="min-h-screen flex flex-col items-center justify-center p-4 text-white text-center relative overflow-hidden font-sans"
                style={{
                    backgroundColor: '#450a0a'
                }}
              >
                <div className="relative z-10 max-w-4xl w-full flex flex-col items-center">
                    <div className="w-full max-w-2xl bg-black/20 rounded-2xl overflow-hidden shadow-2xl border-4 border-red-900/50 mb-6">
                        <img 
                            src={failImage} 
                            alt="æŒ‘æˆ°å¤±æ•—" 
                            className="w-full h-auto object-contain"
                            style={{ maxHeight: '60vh' }}
                        />
                    </div>
                    
                    <div className="text-center">
                        <h1 className="text-5xl font-bold mb-4 text-red-100 drop-shadow-lg">æŒ‘æˆ°å¤±æ•—</h1>
                        <button onClick={resetGame} className="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-full text-lg transition-colors flex items-center shadow-xl mx-auto border-2 border-red-400">
                            <RefreshCw className="mr-2" /> é‡æ–°æŒ‘æˆ°
                        </button>
                    </div>
                </div>
              </div>
            );
          }

          // 3. ç­”é¡Œç•«é¢
          if (gameState === 'quiz') {
            return (
              <div 
                className="min-h-screen flex items-center justify-center p-4 relative bg-cover bg-center"
                style={{
                    backgroundImage: `url("./ç¬¬${numToChinese[currentLevelId]}é—œ.png")`,
                    backgroundColor: '#1e293b'
                }}
              >
                <div className="absolute inset-0 bg-black/50 pointer-events-none"></div>
                
                <div className="absolute top-4 right-4 z-20 flex flex-col items-end space-y-2">
                    <div className="bg-indigo-800/80 text-yellow-300 px-4 py-2 rounded-full font-bold border border-indigo-500 flex items-center">
                        <Star className="mr-2 fill-current" size={18} />
                        <span>{score}</span>
                    </div>
                    <div className="bg-red-900/80 px-4 py-2 rounded-full border border-red-500 flex items-center space-x-1">
                        {[...Array(5)].map((_, i) => (
                            <Heart key={i} className={`w-6 h-6 transition-all duration-300 ${i < lives ? 'text-red-500 fill-red-500' : 'text-gray-600 fill-none'}`} />
                        ))}
                    </div>
                </div>

                <div className="max-w-3xl w-full bg-white rounded-3xl shadow-2xl overflow-hidden relative z-10">
                  <div className="bg-indigo-600 p-6 flex justify-between items-center text-white">
                    <div className="flex items-center gap-3">
                       <h2 className="text-2xl font-bold">{currentLevelData.title}</h2>
                    </div>
                    <button onClick={() => setGameState('map')} className="text-indigo-200 hover:text-white transition-colors">
                      è¿”å›åœ°åœ–
                    </button>
                  </div>
                  <div className="p-8">
                    <div className="bg-amber-50 border-2 border-amber-200 p-8 rounded-xl mb-8 shadow-inner transform rotate-1 min-h-[200px] flex items-center justify-center">
                      <pre className="font-serif text-2xl text-gray-800 leading-loose text-center whitespace-pre-wrap font-medium">
                        {currentQuestionData.poem}
                      </pre>
                    </div>
                    
                    <div className={`grid gap-4 ${fixedLevelOptions.length > 4 ? 'grid-cols-2 md:grid-cols-3' : 'grid-cols-1 md:grid-cols-2'}`}>
                      {fixedLevelOptions.map((option, idx) => {
                        let btnClass = "p-6 text-2xl rounded-xl border-2 font-bold transition-all transform hover:scale-105 ";
                        if (selectedAnswer === option) {
                          if (isCorrect === true) btnClass += "bg-green-500 border-green-600 text-white shadow-green-200";
                          else if (isCorrect === false) btnClass += "bg-red-500 border-red-600 text-white shadow-red-200";
                          else btnClass += "bg-blue-500 border-blue-600 text-white";
                        } else {
                          btnClass += "bg-white border-gray-200 text-gray-700 hover:border-indigo-400 hover:shadow-md";
                        }
                        return (
                          <button key={idx} onClick={() => !isCorrect && handleAnswerCheck(option)} disabled={isCorrect === true} className={btnClass}>
                            {option}
                          </button>
                        );
                      })}
                    </div>
                    <div className="mt-6 h-8 text-center">
                      {isCorrect === true && (
                        <span className="text-green-600 font-bold text-xl flex items-center justify-center animate-pulse">
                          <Check className="mr-2" /> {currentQuestionIdx < currentLevelData.questions.length - 1 ? "ç­”å°äº†ï¼ä¸‹ä¸€é¡Œ..." : "å…¨æ•¸é€šéï¼å³å°‡å‰å¾€åœ°åœ–..."}
                        </span>
                      )}
                      {isCorrect === false && <span className="text-red-500 font-bold text-xl animate-bounce">å†è©¦ä¸€æ¬¡ï¼ç´°ç´°å“å‘³è©©å¥...</span>}
                    </div>
                  </div>
                </div>
              </div>
            );
          }

          // 4. åœ°åœ–ç•«é¢
          return (
            <div className="min-h-screen relative overflow-hidden font-sans" style={{
                backgroundImage: 'url("./æ–°è©©å†’éšªåº•åœ–.png")',
                backgroundSize: 'cover', backgroundPosition: 'center', backgroundRepeat: 'no-repeat', backgroundColor: '#166534'
              }}>
              <div className="container mx-auto h-screen p-4 flex flex-col relative z-10">
                <h1 className="text-3xl md:text-4xl text-white font-bold text-center mt-4 drop-shadow-md flex items-center justify-center bg-black/40 p-2 rounded-xl backdrop-blur-sm w-fit mx-auto">
                  <BookOpen className="mr-3" /> è©©é‡ä»™è¹¤åœ°åœ–
                </h1>
                <p className="text-center text-white font-bold mt-2 drop-shadow-md">é»æ“Šç™¼äº®çš„é—œå¡é–‹å§‹æŒ‘æˆ°</p>
                
                <div className="absolute top-4 right-4 md:top-8 md:right-8 flex flex-col items-end space-y-2 z-50">
                    <div className="bg-yellow-400 text-yellow-900 px-4 py-2 rounded-full font-bold shadow-lg flex items-center border-2 border-yellow-200">
                        <Star className="mr-2 fill-current" size={20} />
                        <span className="text-lg">å¾—åˆ†: {score}</span>
                    </div>
                    <div className="bg-black/60 px-4 py-2 rounded-full border border-white/30 flex items-center space-x-1 backdrop-blur-sm">
                        {[...Array(5)].map((_, i) => (
                            <Heart key={i} className={`w-6 h-6 transition-all duration-300 ${i < lives ? 'text-red-500 fill-red-500 drop-shadow-md' : 'text-gray-500 fill-none opacity-50'}`} />
                        ))}
                    </div>
                </div>

                <div className="flex-1 relative mt-8 rounded-3xl m-4 md:m-8">
                  <svg className="absolute inset-0 w-full h-full pointer-events-none z-0" viewBox="0 0 100 100" preserveAspectRatio="none">
                    <path 
                      d={getSmoothPath()} 
                      fill="none" 
                      stroke="white" 
                      strokeWidth="0.8" 
                      strokeDasharray="2 2"
                      strokeLinecap="round" 
                      strokeLinejoin="round" 
                      className="drop-shadow-lg opacity-90"
                    />
                  </svg>
                  <div className="absolute transform -translate-x-1/2 -translate-y-1/2 flex flex-col items-center z-10" style={{ left: `${START_POS.x}%`, top: `${START_POS.y}%` }}>
                    <div className="bg-green-500 text-white p-2 rounded-full shadow-lg border-2 border-white"><MapPin size={24} /></div>
                    <span className="mt-1 text-white text-xs font-bold bg-black/70 px-2 rounded border border-white/50">èµ·é»</span>
                  </div>
                  
                  {/* ç©å®¶æ£‹å­ (ç™½è‰²) */}
                  <div 
                    className="absolute transform -translate-x-1/2 -translate-y-full z-30 transition-all duration-1000 ease-in-out piece-idle"
                    style={{ left: `${piecePos.x}%`, top: `${piecePos.y}%` }}
                  >
                    <div className="relative">
                        <ChessPiece className="text-white w-12 h-12 drop-shadow-[0_4px_4px_rgba(0,0,0,0.5)]" />
                        <div className="absolute bottom-0 left-1/2 -translate-x-1/2 w-8 h-2 bg-black/40 rounded-full blur-sm"></div>
                    </div>
                  </div>

                  {/* å¯¶ç®±æŒ‰éˆ• */}
                  <div 
                    className={`absolute transform -translate-x-1/2 -translate-y-1/2 z-20 transition-all duration-300 ${unlockedLevel >= 5 && !chestOpened ? 'cursor-pointer hover:scale-110 chest-shake' : 'opacity-50 pointer-events-none grayscale'}`}
                    style={{ left: `${CHEST_POS.x}%`, top: `${CHEST_POS.y}%` }}
                    onClick={handleChestClick}
                  >
                    <div className={`p-3 rounded-full shadow-xl border-4 ${chestOpened ? 'bg-gray-500 border-gray-400' : 'bg-yellow-500 border-yellow-300 animate-bounce'}`}>
                        <Gift className="text-white w-8 h-8" />
                    </div>
                    {!chestOpened && unlockedLevel >= 5 && <span className="absolute top-full mt-1 left-1/2 -translate-x-1/2 bg-yellow-300 text-yellow-900 text-xs font-bold px-2 py-1 rounded shadow-md whitespace-nowrap">é»æˆ‘æŠ½ç!</span>}
                  </div>

                  {/* å¯¶ç®±æŠ½ç Modal */}
                  {showChestModal && (
                      <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                          <div className="bg-white rounded-3xl p-8 max-w-md w-full text-center shadow-2xl animate-bounce-in">
                              <h3 className="text-3xl font-bold text-indigo-900 mb-6">ğŸ å¹¸é‹å¯¶ç®±æ™‚é–“ï¼</h3>
                              {!chestMessage ? (
                                  <div className="grid grid-cols-3 gap-4">
                                      {[1, 2, 3].map(i => (
                                          <button key={i} onClick={() => openChest(i)} className="bg-yellow-100 hover:bg-yellow-200 border-4 border-yellow-400 rounded-xl p-4 flex flex-col items-center transition-all hover:-translate-y-2">
                                              <Gift className="w-12 h-12 text-yellow-600 mb-2" />
                                              <span className="font-bold text-yellow-800">å¯¶ç®± {i}</span>
                                          </button>
                                      ))}
                                  </div>
                              ) : (
                                  <div className="py-8 animate-pulse">
                                      <p className="text-2xl font-bold text-red-600">{chestMessage}</p>
                                  </div>
                              )}
                          </div>
                      </div>
                  )}

                  {GAME_DATA.map((level) => {
                    const isUnlocked = level.id <= unlockedLevel;
                    const isCompleted = level.id < unlockedLevel;
                    const isCurrent = level.id === unlockedLevel;
                    return (
                      <button key={level.id} onClick={() => handleLevelClick(level.id)} disabled={!isUnlocked} className={`absolute transform -translate-x-1/2 -translate-y-1/2 transition-all duration-300 group ${isCurrent ? 'scale-110 z-20 hover:scale-125' : 'scale-100 z-10 hover:scale-110'}`} style={{ left: `${level.layout.x}%`, top: `${level.layout.y}%` }}>
                        <div className={`w-12 h-12 md:w-16 md:h-16 rounded-full flex items-center justify-center shadow-xl border-4 ${isCompleted ? 'bg-yellow-400 border-yellow-200 text-yellow-900' : isCurrent ? 'bg-blue-500 border-white text-white animate-pulse ring-4 ring-blue-300/50' : 'bg-gray-600 border-gray-500 text-gray-400'}`}>
                          {isCompleted ? <Check size={28} strokeWidth={3} /> : !isUnlocked ? <Lock size={20} /> : <span className="text-xl md:text-2xl font-bold">{level.id}</span>}
                        </div>
                        <div className={`absolute top-full mt-2 w-32 left-1/2 -translate-x-1/2 text-center transition-opacity ${isUnlocked ? 'opacity-100' : 'opacity-0'}`}>
                          <span className={`text-xs md:text-sm font-bold px-2 py-1 rounded shadow-md border ${isCurrent ? 'bg-blue-600 text-white border-blue-300' : 'bg-white text-gray-800 border-gray-300'}`}>{level.title}</span>
                        </div>
                      </button>
                    );
                  })}
                  
                  {/* çµ‚é» - ä¿®æ”¹ç‚ºå¯é»æ“Š */}
                  <div 
                    className={`absolute transform -translate-x-1/2 -translate-y-1/2 flex flex-col items-center z-10 transition-all duration-300 ${unlockedLevel >= 8 ? 'cursor-pointer hover:scale-110 animate-bounce' : ''}`}
                    style={{ left: `${END_POS.x}%`, top: `${END_POS.y}%` }}
                    onClick={handleEndClick}
                  >
                     <div className={`p-3 rounded-full shadow-lg border-4 ${unlockedLevel >= 8 ? 'bg-yellow-400 border-white ring-4 ring-yellow-200' : 'bg-gray-700 border-gray-600'}`}>
                      <Trophy size={32} className={unlockedLevel >= 8 ? 'text-red-600' : 'text-gray-400'} />
                    </div>
                    <span className="mt-2 text-yellow-300 font-bold text-sm bg-black/70 px-2 rounded border border-yellow-500/50">
                        {unlockedLevel >= 8 ? "é»æ“Šé€šé—œ!" : "çµ‚é»"}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<PoetryGame />);
    </script>
</body>
</html>